<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Network Search</title>
</head>
<body>
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="flash {{ category }}">{{ message }}</div>
    {% endfor %}
  {% endif %}
{% endwith %}

{% if netmiko_output %}
  <div class="netmiko-output">
    <strong>Netmiko Config Command Output:</strong>
    <pre>{{ netmiko_output }}</pre>
  </div>
{% endif %}

<form method="POST" action="/search">
    <label for="query">Search</label>
    <input type="text" id="query" name="query" placeholder="Hostname, MAC, or Description">
    <button type="submit">Search</button>
</form>

<form method="POST" action="/change_vlan">
    <div>
        <label>Hostname</label>
        <span>{{ fields.host or '-' }}</span>
        <input type="hidden" name="host" value="{{ fields.host }}">
    </div>

    <div>
        <label for="interface">Interface</label>
        {% if fields.available_interfaces %}
            {% set current_short = fields.interface|replace('GigabitEthernet', 'Gi')|replace('FastEthernet', 'Fa') %}
            <select name="interface" id="interface" onchange="this.form.submit()">
                {% for iface in fields.available_interfaces %}
                    {% set short_name = iface|replace('GigabitEthernet', 'Gi')|replace('FastEthernet', 'Fa') %}
                    <option value="{{ short_name }}"
                        {% if short_name == (requested_interface or current_short) %}selected{% endif %}>
                        {{ iface }}
                    </option>
                {% endfor %}
            </select>
        {% else %}
            <span>{{ fields.interface or '-' }}</span>
            <input type="hidden" name="interface" value="{{ fields.interface }}">
        {% endif %}
    </div>

    <div>
        <label>MAC Address</label>
        <span>{{ fields.mac_address or '-' }}</span>
    </div>

    <div>
        <label>VLAN</label>
        {% if fields.available_vlans %}
            <div>
                <strong>Current VLAN - </strong>
                <span>{{ fields.vlan or 'N/A' }}</span>
            </div>
            <select name="new_vlan" id="new_vlan">
                {% for vlan_id in fields.available_vlans %}
                    {% set is_selected = vlan_id|string == (requested_vlan or fields.vlan)|string %}
                    <option value="{{ vlan_id }}" {% if is_selected %}selected{% endif %}>{{ vlan_id }}</option>
                {% endfor %}
            </select>
            <input type="hidden" name="current_vlan" value="{{ fields.vlan }}">
        {% else %}
            <span>{{ fields.vlan or '-' }}</span>
            <input type="hidden" name="new_vlan" value="{{ fields.vlan }}">
        {% endif %}
    </div>

    <div>
        <label>Description</label>
        <span>{{ fields.description or '-' }}</span>
    </div>

    <div>
        <label>SNMP Location</label>
        <span>{{ fields.snmp_location or '-' }}</span>
    </div>

    {% if confirmation_message %}
        <div class="confirmation">{{ confirmation_message|safe }}</div>
        <input type="hidden" name="confirm" value="1">
        <input type="hidden" name="change_vlan" value="1">  <!-- ADD THIS -->
        <button type="submit">Confirm VLAN Change</button>
    {% elif fields.available_vlans %}
        <button type="submit" name="change_vlan" value="1">Submit VLAN Change</button>
    {% endif %}

    {% if success_message %}
        <div class="success">{{ success_message|safe }}</div>
    {% endif %}
</form>
</body>
</html>
